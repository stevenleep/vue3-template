# é˜²æ­¢æ„å»ºå·¥å…·å¸¦æ¥çš„éº»çƒ¦ï¼Œå°†çº¿ä¸Šæœ¬åœ°å¼€å‘æ—¶å€™çš„ç‰ˆæœ¬ç»Ÿä¸€
# ç‰ˆæœ¬å¦‚ä¸‹ï¼š
# nodeç‰ˆæœ¬16.15.0
# pnpmç‰ˆæœ¬7.1.7 (ä¸ºä»€ä¹ˆä½¿ç”¨pnpm: https://pnpm.io/zh/motivation)
image: node:16.15.0

default:
  only:
    - master
    - develop
    - /^feature\/(WIP-|Draft-).*$/
    - /^release\/.*$/
    - /^hotfix\/.*$/
    - tags # /^v.*$/
  except:
    - schedules

# define stages for jobs
stages:
  - .pre
  - preinstall
  - lint
  - build
  - test
  - dockerize # docker build é˜¶æ®µ, å®Œæˆåå¯è€ƒè™‘ä½¿ç”¨ kubectl apply æ¥è¿›è¡Œèµ„æºéƒ¨ç½²/æ›´æ–°
  - deploy
  - .post

variables:
  # docker build variables
  - IMAGE_NAME: ddhmit-frontend-admin
  - CI_IMAGE: $CI_REGISTRY_IMAGE/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA

# before_script åœ¨æ¯ä¸ªjobæ‰§è¡Œå‰æ‰§è¡Œ
before_script:
  - node -v
  - npm -v
  - |
    if [ $CI_JOB_STAGE == "preinstall" ] || [ $CI_JOB_STAGE == "build" ] || [ $CI_JOB_STAGE == "lint" ]; then
      echo "âœ… switch to use taobao registry"
      npm set registry https://registry.npmmirror.com/

      echo "âœ… switch to PNPM for package management..."
      npm install -g pnpm
      pnpm -v
    else
      echo "âœ… the job at this stage does not need to use pnpm, skip automatically" 
    fi

# é¢„å¤„ç† - ç¯å¢ƒæ³¨å…¥
#
# åœ¨ prepare environment é˜¶æ®µå°† CI/CD ä¸­çš„å˜é‡æ³¨å…¥åˆ°é¡¹ç›®ç¯å¢ƒå˜é‡ä¸­
# å‰ç«¯é¡¹ç›®æä¾› scripts/init-env.sh è„šæœ¬æ¥å®ç°ç¯å¢ƒæ³¨å…¥(å½“CIæ‰§è¡Œæ—¶å€™ä¼šè°ƒç”¨è¿™ä¸ªè„šæœ¬)
#
# XXX: æä¾›é»˜è®¤çš„ init-env.sh è„šæœ¬?
#
set-environment:
  stage: .pre
  script:
    - ls -lsa ./scripts/init-env.sh
    - whoami
    - chmod +x ./scripts/init-env.sh
    - ./scripts/init-env.sh
  inherit:
    default:
      - only

# é¢„å¤„ç† - å®‰è£…ä¾èµ–/ç¼“å­˜ä¾èµ–
preinstall:
  stage: preinstall
  cache:
    key:
      files:
        - package.json
        - pnpm-lock.yaml
    paths:
      - node_modules
      - .pnpm-store
      # - dist
    policy: pull-push
  # ref: https://docs.gitlab.com/ee/ci/yaml/#retrywhen
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      # - api_failure # ç”±äºç½‘ç»œé—®é¢˜ï¼Œå¯¼è‡´apiå¤±è´¥(äº¤ç»™éƒ¨ç½²å¹³å°è‡ªå·±å¤„ç†ï¼Œå¦‚æœæœ‰)
  script:
    - echo "ğŸ“¦ install dependencies"
    - pnpm install

# ä»£ç æ£€æŸ¥
# --------------------------------------------------------------------
# eslint ä»£ç æ£€æŸ¥
eslint:
  stage: lint
  dependencies:
    - preinstall
  cache:
    key:
      files:
        - package.json
        - pnpm-lock.yaml
    paths:
      - node_modules
      - .pnpm-store
      # - dist
    policy: pull
  script:
    - echo "ğŸ” eslint\:run ESLINT for code verification"
    - pnpm lint

# å•å…ƒæµ‹è¯•æ ¡éªŒ
test:
  stage: lint
  dependencies:
    - preinstall
  cache:
    key:
      files:
        - package.json
        - pnpm-lock.yaml
    paths:
      - node_modules
      - .pnpm-store
      # - dist
    policy: pull
  script:
    - echo "ğŸ” run test case"
    - pnpm test

# æ„å»º
# --------------------------------------------------------------------
build:
  stage: build
  dependencies:
    - "set-environment"
    - "preinstall"
  cache:
    key:
      files:
        - package.json
        - pnpm-lock.yaml
    paths:
      - node_modules
      - dist
    policy: pull-push
  script:
    - echo "ğŸš€ build $CI_COMMIT_REF_NAME environment"
    - cat .env.production
    - cat .env.development
    - pnpm build
  artifacts:
    name: '"$CI_COMMIT_REF_SLUG"-"$CI_COMMIT_SHORT_SHA"'
    paths:
      - dist
    expire_in: 2 day # 2å¤©åè¿‡æœŸ
    when: always # æ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¸Šä¼ 
  inherit:
    default:
      - only

# docker Login
.docker-login:
  before_script:
    - echo "ğŸ”‘ docker login"
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  inherit:
    default:
      - only

# docker ç¼–æ’
docker-build:
  extends: .docker-login
  stage: dockerize
  image: docker
  services:
    - docker:dind
  cache:
    key:
      files:
        - package.json
        - pnpm-lock.yaml
    paths:
      - dist
    policy: pull
  script:
    - echo "ğŸ³ build docker image"
    - docker build -t $CI_IMAGE .
    - docker push $CI_IMAGE

# æµ‹è¯•
# æ£€æµ‹æ„å»ºç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸ
# --------------------------------------------------------------------
# æ£€æŸ¥æ„å»ºäº§ç‰© dist ç›®å½•æ˜¯å¦å­˜åœ¨
check-dist:
  stage: test
  script:
    - |
      if [ -d "dist" ] ; then
        echo "âœ… dist directory exists"
        echo "can start execute deployment jobs"
      else
          echo "âŒ dist directory does not exist"
          echo "you can check the code error through the output log."
          echo "If you find that it is a flow line configuration problem, please feedback the problem to the maintenance personnel!"
      fi
  inherit:
    default:
      - only

# source mapæ£€æŸ¥
# å¦‚æœéœ€è¦éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œsource map å¯¹ç›‘æ§ç³»ç»Ÿæ˜¯éå¸¸æœ‰å¿…è¦çš„
check-sourcemap:
  stage: test
  only:
    - master
    - /^hotfix\/.*$/
    - tags # /^v.*$/
  script:
    - if [ -f "/dist/*.map" ]; then echo "source map exists"; fi

# docker Test
docker-test:
  extends: .docker-login
  stage: test
  image: docker
  services:
    - docker:dind
  script:
    - echo "ğŸ³ test docker image"
    - docker pull $CI_IMAGE
    - docker run $CI_IMAGE
    # TODO: ...

# éƒ¨ç½²
# --------------------------------------------------------------------
# å¼€å‘ç¯å¢ƒ
deploy-dev:
  stage: deploy
  only:
    - develop
    - /^feature\/(WIP-|Draft-).*$/
  script:
    - echo "ğŸš€ deploy to dev environment"
    - ls -lsa dist

# é¢„ç”Ÿäº§ç¯å¢ƒ
deploy-release:
  stage: deploy
  only:
    - /^release\/.*$/
  script:
    - echo "ğŸš€ deploy to release environment"
    - ls -lsa dist
  when: manual # æ‰‹åŠ¨è§¦å‘(æµ‹è¯•äººå‘˜è¿›è¡Œ)

# æ­£å¼ç¯å¢ƒ
deploy-prod:
  stage: deploy
  only:
    - master
    - /^hotfix\/.*$/
    - tags # /^v.*$/
  script:
    - echo "ğŸš€ deploy to prod environment"
    - ls -lsa dist
  when: manual # æ‰‹åŠ¨è§¦å‘(æµ‹è¯•äººå‘˜/è¿ç»´è¿›è¡Œ/æœ‰ä¸€å®šæƒé™çš„äººå‘˜è¿›è¡Œ)
